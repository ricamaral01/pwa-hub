<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CONCRETRACK ‚Ä¢ Parada Usina</title>

  <!-- PWA (manifest unificado na raiz) -->
  <link rel="manifest" href="../manifest.json">
  <meta name="theme-color" content="#2F3640">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- anti-cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg0:#2F3640; --bg1:#262C35; --bg2:#1F242C;
      --line: rgba(255,255,255,.12); --line2: rgba(255,255,255,.18);
      --text:#F3F6FF; --muted:#B9C4D0;
      --ok:#16A34A; --warn:#F59E0B; --err:#EF4444;
      --accent:#E05533;
      --shadow: 0 18px 45px rgba(0,0,0,.45);
    }
    *{ box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body{
      margin:0; min-height:100vh; color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,255,255,.06), transparent 55%),
        radial-gradient(900px 600px at 80% 30%, rgba(0,0,0,.35), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg2));
    }
    .wrap{ max-width:720px; margin:0 auto; padding:18px; }
    .title{ font-size:28px; font-weight:1000; letter-spacing:.3px; }
    .subtitle{ font-size:14px; color:var(--muted); margin:6px 0 10px; line-height:1.2; }
    .accentLine{ height:4px; border-radius:999px; background: linear-gradient(90deg,#E05533,#F59E0B,transparent); opacity:.9; margin:10px 0 14px; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.20));
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      display:grid;
      gap:14px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(6px);
    }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .ops{ display:flex; gap:10px; flex-wrap:wrap; }
    .field{ background: rgba(0,0,0,.25); border:1px solid var(--line2); border-radius:14px; padding:12px; }
    .label{ font-size:14px; font-weight:900; color:var(--muted); }
    input, select, textarea{
      margin-top:8px; width:100%;
      font-size:18px; font-weight:900;
      padding:14px; border-radius:14px;
      border:1px solid rgba(224,85,51,.35);
      background: rgba(0,0,0,.35);
      color:var(--text);
      outline:none;
      font-family: inherit;
    }
    input:focus, select:focus, textarea:focus{
      box-shadow:0 0 0 4px rgba(224,85,51,.15);
      border-color: rgba(224,85,51,.55);
    }
    select option{ background:#1F242C; color:var(--text); }
    textarea{ resize:vertical; min-height:80px; }

    .btn{
      padding:18px; border-radius:18px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.30);
      color:var(--text);
      font-weight:1000;
      font-size:18px;
      cursor:pointer;
      flex:1;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.good{ background: linear-gradient(180deg,#E05533,#B8432A); color:#fff; border-color: rgba(224,85,51,.9); text-shadow: 0 1px 0 rgba(0,0,0,.20); }
    .btn.light{ background: rgba(255,255,255,.06); }
    .btn.danger{ background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.35); }

    .pillRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{
      display:flex; align-items:center; gap:12px;
      padding:16px 18px;
      border-radius:999px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.30);
      font-size:16px;
      font-weight:900;
      flex: 1;
      min-width: 200px;
    }
    .dot{ width:14px; height:14px; border-radius:999px; background:var(--muted); }
    .dot.ok{ background:var(--ok); }
    .dot.warn{ background:var(--warn); }
    .dot.err{ background:var(--err); }

    .segRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .segBtn{
      flex:1; min-width:100px;
      padding:14px 10px;
      border-radius:14px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.30);
      color:var(--muted);
      font-weight:900; font-size:15px;
      cursor:pointer; text-align:center;
      user-select:none;
      transition: all .15s ease;
    }
    .segBtn.active{
      background: rgba(224,85,51,.25);
      border-color: rgba(224,85,51,.7);
      color:var(--text);
    }

    .history{ margin-top:16px; }
    .histItem{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      margin-bottom:8px;
      font-size:14px;
    }
    .histItem b{ color:var(--accent); }

    @media(max-width:520px){
      .grid2{ grid-template-columns:1fr; }
      .segRow{ flex-direction:column; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <a href="../index.html" style="display:inline-flex;align-items:center;gap:8px;color:var(--muted);text-decoration:none;font-size:14px;font-weight:900;margin-bottom:8px;">‚Üê Hub</a>
  <div class="title">üè≠ CONCRETRACK ‚Ä¢ Parada Usina</div>
  <div class="subtitle">Registrar paradas t√©cnicas da usina ‚Üí Planilha Google Sheets</div>
  <div class="accentLine"></div>

  <div class="card">
    <form id="frm" autocomplete="off">

      <div class="grid2">
        <div class="field">
          <div class="label">Data</div>
          <input id="data" type="date" required>
        </div>
        <div class="field">
          <div class="label">Hora In√≠cio</div>
          <input id="horaInicio" type="time" step="60" required>
        </div>
      </div>

      <div class="grid2">
        <div class="field">
          <div class="label">Hora Fim</div>
          <input id="horaFim" type="time" step="60">
        </div>
        <div class="field">
          <div class="label">Dura√ß√£o (min)</div>
          <input id="duracao" type="number" min="0" placeholder="Auto" readonly>
        </div>
      </div>

      <div class="field">
        <div class="label">Tipo de Parada</div>
        <div class="segRow">
          <div class="segBtn" data-group="tipo" data-value="Mec√¢nica">üîß Mec√¢nica</div>
          <div class="segBtn" data-group="tipo" data-value="El√©trica">‚ö° El√©trica</div>
          <div class="segBtn" data-group="tipo" data-value="Operacional">üèóÔ∏è Operacional</div>
          <div class="segBtn" data-group="tipo" data-value="Limpeza">üßπ Limpeza</div>
          <div class="segBtn" data-group="tipo" data-value="Outros">üìã Outros</div>
        </div>
        <input type="hidden" id="tipo" value="">
      </div>

      <div class="field">
        <div class="label">Equipamento</div>
        <input id="equipamento" placeholder="Ex.: Misturador, Correia, Silo..." required>
      </div>

      <div class="field">
        <div class="label">Descri√ß√£o da Parada</div>
        <textarea id="descricao" placeholder="Descreva o motivo da parada..." required></textarea>
      </div>

      <div class="ops">
        <button class="btn light" id="btnAgora" type="button">üïí Agora</button>
        <button class="btn danger" id="btnLimpar" type="button">üßπ Limpar</button>
        <button class="btn good" id="btnSalvar" type="submit">üì§ REGISTRAR</button>
      </div>

      <div class="pillRow">
        <div class="pill">
          <span id="dot" class="dot warn"></span>
          <span id="statusTxt">Pronto para registrar</span>
        </div>
      </div>

    </form>
  </div>

  <div class="history" id="history"></div>
</div>

<script>
/* ===============================
   ‚úÖ SW UNIFICADO
   =============================== */
(async function(){
  try{
    if ("serviceWorker" in navigator) {
      await navigator.serviceWorker.register("../sw.js", { scope: "../" });
    }
  }catch(e){}
})();

/* ===============================
   ‚úÖ CONFIG ‚Äî Substitua pela URL do seu Apps Script
   =============================== */
const CONFIG = {
  API_URL: "COLE_AQUI_SUA_URL_DO_APPS_SCRIPT"
};

const $ = (id) => document.getElementById(id);

const frm = $("frm");
const dot = $("dot");
const statusTxt = $("statusTxt");

/* ===============================
   ‚úÖ HELPERS
   =============================== */
function pad2(n){ return String(n).padStart(2,"0"); }

function setStatus(kind, text){
  dot.classList.remove("ok","warn","err");
  dot.classList.add(kind);
  statusTxt.textContent = text;
}

function setNow(){
  const d = new Date();
  $("data").value = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  $("horaInicio").value = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

function calcDuracao(){
  const ini = $("horaInicio").value;
  const fim = $("horaFim").value;
  if (!ini || !fim){ $("duracao").value = ""; return; }
  const [h1,m1] = ini.split(":").map(Number);
  const [h2,m2] = fim.split(":").map(Number);
  let diff = (h2*60+m2) - (h1*60+m1);
  if (diff < 0) diff += 1440;
  $("duracao").value = diff;
}

/* ===============================
   ‚úÖ SEGMENTED BUTTONS
   =============================== */
function setActive(group, value){
  document.querySelectorAll(`.segBtn[data-group="${group}"]`).forEach(b => {
    b.classList.toggle("active", b.dataset.value === value);
  });
  if (group === "tipo") $("tipo").value = value;
}

document.querySelectorAll(".segBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    setActive(btn.dataset.group, btn.dataset.value);
  });
});

/* ===============================
   ‚úÖ EVENTS
   =============================== */
$("horaInicio").addEventListener("change", calcDuracao);
$("horaFim").addEventListener("change", calcDuracao);

$("btnAgora").addEventListener("click", () => {
  setNow();
  calcDuracao();
});

$("btnLimpar").addEventListener("click", () => {
  frm.reset();
  $("tipo").value = "";
  $("duracao").value = "";
  setActive("tipo", "");
  setStatus("warn", "Pronto para registrar");
});

/* ===============================
   ‚úÖ HIST√ìRICO LOCAL
   =============================== */
function loadHistory(){
  const hist = JSON.parse(localStorage.getItem("parada_hist") || "[]");
  const el = $("history");
  if (!hist.length){ el.innerHTML = ""; return; }
  el.innerHTML = "<div class='label' style='margin-bottom:8px;'>√öltimos registros</div>" +
    hist.slice(-5).reverse().map(h =>
      `<div class="histItem"><span>${h.data} ${h.horaInicio}‚Äì${h.horaFim || "?"}</span><b>${h.tipo}</b><span>${h.equipamento}</span></div>`
    ).join("");
}

function saveHistory(payload){
  const hist = JSON.parse(localStorage.getItem("parada_hist") || "[]");
  hist.push(payload);
  if (hist.length > 20) hist.splice(0, hist.length - 20);
  localStorage.setItem("parada_hist", JSON.stringify(hist));
  loadHistory();
}

/* ===============================
   ‚úÖ SALVAR ‚Üí GOOGLE SHEETS
   =============================== */
async function apiPost(payload){
  const res = await fetch(CONFIG.API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  });
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { ok:false, raw:text }; }
}

frm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const tipo = $("tipo").value;
  if (!tipo){
    setStatus("warn", "Selecione o Tipo de Parada");
    return;
  }

  const payload = {
    action: "registrar_parada",
    data: $("data").value,
    horaInicio: $("horaInicio").value,
    horaFim: $("horaFim").value || "",
    duracao: $("duracao").value || "",
    tipo: tipo,
    equipamento: $("equipamento").value.trim(),
    descricao: $("descricao").value.trim()
  };

  if (!payload.data || !payload.horaInicio || !payload.equipamento || !payload.descricao){
    setStatus("warn", "Preencha todos os campos obrigat√≥rios");
    return;
  }

  setStatus("warn", "Salvando...");
  $("btnSalvar").disabled = true;

  try {
    const r = await apiPost(payload);
    if (r && r.ok){
      setStatus("ok", "Parada registrada ‚úÖ");
      saveHistory(payload);

      // Limpar formul√°rio mantendo a data
      const keepData = $("data").value;
      frm.reset();
      $("tipo").value = "";
      $("duracao").value = "";
      setActive("tipo", "");
      $("data").value = keepData;
    } else {
      setStatus("err", "Erro: " + (r?.message || r?.error || "Falha ao salvar"));
    }
  } catch(err){
    console.error(err);
    setStatus("err", "Erro de conex√£o ‚ùå");
  } finally {
    $("btnSalvar").disabled = false;
  }
});

/* ===============================
   ‚úÖ INIT
   =============================== */
setNow();
setStatus("warn", "Pronto para registrar");
loadHistory();
</script>
</body>
</html>

<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CONCRETRACK â€¢ Parada Usina</title>

  <!-- PWA (manifest unificado na raiz) -->
  <link rel="manifest" href="../manifest.json">
  <meta name="theme-color" content="#2F3640">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- anti-cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="../styles.css">
</head>

<body>
<div class="wrap">
  <a class="back" href="../index.html">â† Hub</a>
  <div class="title">ğŸ­ CONCRETRACK â€¢ Parada Usina</div>
  <div class="subtitle">Registrar paradas tÃ©cnicas da usina â†’ Planilha Google Sheets</div>
  <div class="accentLine"></div>

  <div class="card">
    <form id="frm" autocomplete="off">

      <!-- Data e Hora -->
      <div class="grid2">
        <div class="field">
          <div class="label">Data</div>
          <input id="dataParada" type="date" required>
        </div>
        <div class="field">
          <div class="label">Hora</div>
          <input id="horaParada" type="time" step="60" required>
        </div>
      </div>

      <!-- Equipamento -->
      <div class="field">
        <div class="label">Equipamento</div>
        <input id="equipamento" placeholder="Ex.: Misturador, Correia, Silo..." required>
      </div>

      <!-- DuraÃ§Ã£o -->
      <div class="field">
        <div class="label">DuraÃ§Ã£o (minutos)</div>
        <input id="duracao" type="number" min="0" placeholder="Ex.: 45" required>
      </div>

      <!-- Motivo -->
      <div class="field">
        <div class="label">Motivo</div>
        <div class="segRow">
          <div class="segBtn" data-group="motivo" data-value="MecÃ¢nica">ğŸ”§ MecÃ¢nica</div>
          <div class="segBtn" data-group="motivo" data-value="ElÃ©trica">âš¡ ElÃ©trica</div>
          <div class="segBtn" data-group="motivo" data-value="Operacional">ğŸ—ï¸ Operacional</div>
          <div class="segBtn" data-group="motivo" data-value="Limpeza">ğŸ§¹ Limpeza</div>
          <div class="segBtn" data-group="motivo" data-value="Outros">ğŸ“‹ Outros</div>
        </div>
        <input type="hidden" id="motivo" value="">
      </div>

      <!-- DescriÃ§Ã£o -->
      <div class="field">
        <div class="label">DescriÃ§Ã£o</div>
        <textarea id="descricao" placeholder="Descreva detalhes da parada..." required></textarea>
      </div>

      <!-- ResponsÃ¡vel -->
      <div class="field">
        <div class="label">ResponsÃ¡vel</div>
        <input id="responsavel" placeholder="Nome do responsÃ¡vel" required>
      </div>

      <!-- Status -->
      <div class="field">
        <div class="label">Status</div>
        <div class="segRow">
          <div class="segBtn" data-group="status" data-value="Em andamento">ğŸŸ¡ Em andamento</div>
          <div class="segBtn" data-group="status" data-value="Resolvido">ğŸŸ¢ Resolvido</div>
          <div class="segBtn" data-group="status" data-value="Pendente">ğŸ”´ Pendente</div>
        </div>
        <input type="hidden" id="statusVal" value="">
      </div>

      <!-- BotÃµes -->
      <div class="ops">
        <button class="btn light" id="btnAgora" type="button">ğŸ•’ Agora</button>
        <button class="btn danger" id="btnLimpar" type="button">ğŸ§¹ Limpar</button>
        <button class="btn good" id="btnSalvar" type="submit">ğŸ“¤ ENVIAR</button>
      </div>

      <div class="pillRow">
        <div class="pill">
          <span id="dot" class="dot warn"></span>
          <span id="statusTxt">Pronto para registrar</span>
        </div>
      </div>

    </form>
  </div>

  <div class="history" id="history"></div>
</div>

<!-- Modal de Sucesso -->
<div class="modal" id="modal">
  <div class="modal-content">
    <div class="modal-title" id="modalTitle">âœ… Registrado!</div>
    <div class="modal-text" id="modalText">Parada salva na planilha com sucesso.</div>
    <button class="modal-btn" onclick="document.getElementById('modal').classList.remove('show')">OK</button>
  </div>
</div>

<script>
/* ===============================
   SW UNIFICADO
   =============================== */
(async function(){
  try{
    if ("serviceWorker" in navigator) {
      await navigator.serviceWorker.register("../sw.js", { scope: "../" });
    }
  }catch(e){}
})();

/* ===============================
   CONFIG â€” Apps Script para a planilha "tÃ©cnica"
   =============================== */
const API_URL = "https://script.google.com/macros/s/AKfycbzp_VqDJZrjKg0IdUmLMZVwAo0-YfmaaS1TRoRxqT9CRx_tlxNpzkk9eARKY_H2X_17/exec";

const $ = id => document.getElementById(id);

/* ===============================
   HELPERS
   =============================== */
function pad2(n){ return String(n).padStart(2,"0"); }

function setStatus(kind, text){
  const dot = $("dot");
  dot.classList.remove("ok","warn","err");
  dot.classList.add(kind);
  $("statusTxt").textContent = text;
}

function setNow(){
  const d = new Date();
  $("dataParada").value = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  $("horaParada").value = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

/* ===============================
   SEGMENTED BUTTONS
   =============================== */
function setActive(group, value){
  document.querySelectorAll(`.segBtn[data-group="${group}"]`).forEach(b => {
    b.classList.toggle("active", b.dataset.value === value);
  });
  if (group === "motivo") $("motivo").value = value;
  if (group === "status") $("statusVal").value = value;
}

document.querySelectorAll(".segBtn").forEach(btn => {
  btn.addEventListener("click", () => setActive(btn.dataset.group, btn.dataset.value));
});

/* ===============================
   EVENTS
   =============================== */
$("btnAgora").addEventListener("click", setNow);

$("btnLimpar").addEventListener("click", () => {
  $("frm").reset();
  $("motivo").value = "";
  $("statusVal").value = "";
  setActive("motivo", "");
  setActive("status", "");
  setStatus("warn", "Pronto para registrar");
});

/* ===============================
   HISTÃ“RICO LOCAL
   =============================== */
function loadHistory(){
  const hist = JSON.parse(localStorage.getItem("parada_hist") || "[]");
  const el = $("history");
  if (!hist.length){ el.innerHTML = ""; return; }
  el.innerHTML = "<div class='label' style='margin-bottom:8px;'>Ãšltimos registros</div>" +
    hist.slice(-5).reverse().map(h =>
      `<div class="histItem">
        <span>${h.dataHora}</span>
        <b>${h.motivo}</b>
        <span>${h.equipamento}</span>
        <span style="color:var(--muted)">${h.status}</span>
      </div>`
    ).join("");
}

function saveHistory(payload){
  const hist = JSON.parse(localStorage.getItem("parada_hist") || "[]");
  hist.push(payload);
  if (hist.length > 30) hist.splice(0, hist.length - 30);
  localStorage.setItem("parada_hist", JSON.stringify(hist));
  loadHistory();
}

/* ===============================
   ENVIAR â†’ GOOGLE SHEETS (aba "tÃ©cnica")
   =============================== */
async function apiPost(payload){
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  });
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { ok:false, raw:text }; }
}

$("frm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const motivo = $("motivo").value;
  const status = $("statusVal").value;

  if (!motivo){
    setStatus("warn", "Selecione o Motivo");
    return;
  }
  if (!status){
    setStatus("warn", "Selecione o Status");
    return;
  }

  const dataISO = $("dataParada").value;
  const hora    = $("horaParada").value;

  const payload = {
    action: "registrar_parada",
    dataHora: dataISO + " " + hora,
    equipamento: $("equipamento").value.trim(),
    duracao: $("duracao").value,
    motivo: motivo,
    descricao: $("descricao").value.trim(),
    responsavel: $("responsavel").value.trim(),
    status: status
  };

  if (!dataISO || !hora || !payload.equipamento || !payload.duracao || !payload.descricao || !payload.responsavel){
    setStatus("warn", "Preencha todos os campos obrigatÃ³rios");
    return;
  }

  setStatus("warn", "Salvando...");
  $("btnSalvar").disabled = true;

  try {
    const r = await apiPost(payload);
    if (r && r.ok){
      setStatus("ok", "Parada registrada âœ…");
      saveHistory(payload);

      $("modalTitle").textContent = "âœ… Registrado!";
      $("modalText").textContent = `${payload.equipamento} â€” ${payload.motivo} â€” ${payload.duracao} min`;
      $("modal").classList.add("show");

      // Limpar formulÃ¡rio mantendo a data
      const keepData = $("dataParada").value;
      $("frm").reset();
      $("motivo").value = "";
      $("statusVal").value = "";
      setActive("motivo", "");
      setActive("status", "");
      $("dataParada").value = keepData;
    } else {
      setStatus("err", "Erro: " + (r?.message || r?.error || "Falha ao salvar"));
    }
  } catch(err){
    console.error(err);
    setStatus("err", "Erro de conexÃ£o âŒ");
  } finally {
    $("btnSalvar").disabled = false;
  }
});

/* ===============================
   INIT
   =============================== */
setNow();
setStatus("warn", "Pronto para registrar");
loadHistory();
</script>
</body>
</html>

<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CONCRETRACK â€¢ Massadas</title>

  <!-- PWA (manifest unificado na raiz) -->
  <link rel="manifest" href="../manifest.json">
  <meta name="theme-color" content="#2F3640">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- anti-cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="../styles.css">
</head>

<body>
<div class="wrap">
  <a class="back" href="../index.html">â† Hub</a>
  <div class="title">ğŸ§± CONCRETRACK â€¢ Massadas</div>
  <div class="subtitle">Registrar massadas com problemas â†’ Planilha Google Sheets</div>
  <div class="accentLine"></div>

  <div class="card">
    <form id="frm" autocomplete="off">

      <!-- Data e Hora -->
      <div class="grid2">
        <div class="field">
          <div class="label">Data</div>
          <input id="dataM" type="date" required>
        </div>
        <div class="field">
          <div class="label">Hora</div>
          <input id="horaM" type="time" step="60" required>
        </div>
      </div>

      <!-- NÃºmero de SÃ©rie -->
      <div class="field">
        <div class="label">NÃºmero de SÃ©rie</div>
        <input id="numSerie" placeholder="Ex.: M-2026-045" required>
      </div>

      <!-- Hora da Massada -->
      <div class="field">
        <div class="label">Hora da Massada</div>
        <input id="horaMassada" type="time" step="60" required>
      </div>

      <!-- ExsudaÃ§Ã£o -->
      <div class="field">
        <div class="label">Houve ExsudaÃ§Ã£o?</div>
        <div class="segRow">
          <div class="segBtn" data-group="exsudacao" data-value="Sim">âœ… Sim</div>
          <div class="segBtn" data-group="exsudacao" data-value="NÃ£o">âŒ NÃ£o</div>
        </div>
        <input type="hidden" id="exsudacao" value="">
      </div>

      <!-- NÃ­vel de ExsudaÃ§Ã£o (aparece quando Sim) -->
      <div class="field" id="nivelWrap" style="display:none;">
        <div class="label">NÃ­vel de ExsudaÃ§Ã£o</div>
        <div class="segRow">
          <div class="segBtn" data-group="nivel" data-value="Leve">ğŸŸ¡ Leve</div>
          <div class="segBtn" data-group="nivel" data-value="Moderado">ğŸŸ  Moderado</div>
          <div class="segBtn" data-group="nivel" data-value="Severo">ğŸ”´ Severo</div>
        </div>
        <input type="hidden" id="nivel" value="">
      </div>

      <!-- Perdeu a massada -->
      <div class="field">
        <div class="label">Perdeu a Massada?</div>
        <div class="segRow">
          <div class="segBtn" data-group="perdeu" data-value="Sim">âœ… Sim</div>
          <div class="segBtn" data-group="perdeu" data-value="NÃ£o">âŒ NÃ£o</div>
        </div>
        <input type="hidden" id="perdeu" value="">
      </div>

      <!-- ObservaÃ§Ãµes -->
      <div class="field">
        <div class="label">ObservaÃ§Ãµes</div>
        <textarea id="observacoes" placeholder="Descreva detalhes adicionais..."></textarea>
      </div>

      <!-- BotÃµes -->
      <div class="ops">
        <button class="btn light" id="btnAgora" type="button">ğŸ•’ Agora</button>
        <button class="btn danger" id="btnLimpar" type="button">ğŸ§¹ Limpar</button>
        <button class="btn good" id="btnSalvar" type="submit">ğŸ“¤ ENVIAR</button>
      </div>

      <div class="pillRow">
        <div class="pill">
          <span id="dot" class="dot warn"></span>
          <span id="statusTxt">Pronto para registrar</span>
        </div>
      </div>

    </form>
  </div>

  <div class="history" id="history"></div>
</div>

<!-- Modal de Sucesso -->
<div class="modal" id="modal">
  <div class="modal-content">
    <div class="modal-title" id="modalTitle">âœ… Registrado!</div>
    <div class="modal-text" id="modalText">Massada salva na planilha com sucesso.</div>
    <button class="modal-btn" onclick="document.getElementById('modal').classList.remove('show')">OK</button>
  </div>
</div>

<script>
/* ===============================
   SW UNIFICADO
   =============================== */
(async function(){
  try{
    if ("serviceWorker" in navigator) {
      await navigator.serviceWorker.register("../sw.js", { scope: "../" });
    }
  }catch(e){}
})();

/* ===============================
   CONFIG â€” Apps Script para a aba "massada"
   =============================== */
const API_URL = "https://script.google.com/macros/s/AKfycbzp_VqDJZrjKg0IdUmLMZVwAo0-YfmaaS1TRoRxqT9CRx_tlxNpzkk9eARKY_H2X_17/exec";

const $ = id => document.getElementById(id);

/* ===============================
   HELPERS
   =============================== */
function pad2(n){ return String(n).padStart(2,"0"); }

function setStatus(kind, text){
  const dot = $("dot");
  dot.classList.remove("ok","warn","err");
  dot.classList.add(kind);
  $("statusTxt").textContent = text;
}

function setNow(){
  const d = new Date();
  $("dataM").value = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  $("horaM").value = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

/* ===============================
   SEGMENTED BUTTONS
   =============================== */
function setActive(group, value){
  document.querySelectorAll(`.segBtn[data-group="${group}"]`).forEach(b => {
    b.classList.toggle("active", b.dataset.value === value);
  });
  const hidden = $(group);
  if (hidden) hidden.value = value;

  // Mostrar/esconder nÃ­vel de exsudaÃ§Ã£o
  if (group === "exsudacao") {
    $("nivelWrap").style.display = value === "Sim" ? "" : "none";
    if (value !== "Sim") {
      $("nivel").value = "";
      setActive("nivel", "");
    }
  }
}

document.querySelectorAll(".segBtn").forEach(btn => {
  btn.addEventListener("click", () => setActive(btn.dataset.group, btn.dataset.value));
});

/* ===============================
   EVENTS
   =============================== */
$("btnAgora").addEventListener("click", setNow);

$("btnLimpar").addEventListener("click", () => {
  $("frm").reset();
  ["exsudacao","nivel","perdeu"].forEach(g => { $(g).value = ""; setActive(g, ""); });
  $("nivelWrap").style.display = "none";
  setStatus("warn", "Pronto para registrar");
});

/* ===============================
   HISTÃ“RICO LOCAL
   =============================== */
function loadHistory(){
  const hist = JSON.parse(localStorage.getItem("massadas_hist") || "[]");
  const el = $("history");
  if (!hist.length){ el.innerHTML = ""; return; }
  el.innerHTML = "<div class='label' style='margin-bottom:8px;'>Ãšltimos registros</div>" +
    hist.slice(-5).reverse().map(h =>
      `<div class="histItem">
        <span>${h.dataHora}</span>
        <b>${h.numSerie}</b>
        <span>Exsud: ${h.exsudacao}${h.nivel ? " ("+h.nivel+")" : ""}</span>
        <span>Perdeu: ${h.perdeu}</span>
      </div>`
    ).join("");
}

function saveHistory(payload){
  const hist = JSON.parse(localStorage.getItem("massadas_hist") || "[]");
  hist.push(payload);
  if (hist.length > 30) hist.splice(0, hist.length - 30);
  localStorage.setItem("massadas_hist", JSON.stringify(hist));
  loadHistory();
}

/* ===============================
   ENVIAR â†’ GOOGLE SHEETS (aba "massada")
   =============================== */
async function apiPost(payload){
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  });
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { ok:false, raw:text }; }
}

$("frm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const exsudacao = $("exsudacao").value;
  const perdeu    = $("perdeu").value;
  const nivel     = $("nivel").value;

  if (!exsudacao){
    setStatus("warn", "Informe se houve exsudaÃ§Ã£o");
    return;
  }
  if (exsudacao === "Sim" && !nivel){
    setStatus("warn", "Selecione o nÃ­vel de exsudaÃ§Ã£o");
    return;
  }
  if (!perdeu){
    setStatus("warn", "Informe se perdeu a massada");
    return;
  }

  const dataISO = $("dataM").value;
  const hora    = $("horaM").value;

  const payload = {
    action: "registrar_massada",
    dataHora: dataISO + " " + hora,
    numSerie: $("numSerie").value.trim(),
    horaMassada: $("horaMassada").value,
    exsudacao: exsudacao,
    nivel: exsudacao === "Sim" ? nivel : "",
    perdeu: perdeu,
    observacoes: $("observacoes").value.trim()
  };

  if (!dataISO || !hora || !payload.numSerie || !payload.horaMassada){
    setStatus("warn", "Preencha todos os campos obrigatÃ³rios");
    return;
  }

  setStatus("warn", "Salvando...");
  $("btnSalvar").disabled = true;

  try {
    const r = await apiPost(payload);
    if (r && r.ok){
      setStatus("ok", "Massada registrada âœ…");
      saveHistory(payload);

      $("modalTitle").textContent = "âœ… Registrado!";
      $("modalText").textContent = `SÃ©rie ${payload.numSerie} â€” ExsudaÃ§Ã£o: ${payload.exsudacao}`;
      $("modal").classList.add("show");

      const keepData = $("dataM").value;
      $("frm").reset();
      ["exsudacao","nivel","perdeu"].forEach(g => { $(g).value = ""; setActive(g, ""); });
      $("nivelWrap").style.display = "none";
      $("dataM").value = keepData;
    } else {
      setStatus("err", "Erro: " + (r?.message || r?.error || "Falha ao salvar"));
    }
  } catch(err){
    console.error(err);
    setStatus("err", "Erro de conexÃ£o âŒ");
  } finally {
    $("btnSalvar").disabled = false;
  }
});

/* ===============================
   INIT
   =============================== */
setNow();
setStatus("warn", "Pronto para registrar");
loadHistory();
</script>
</body>
</html>

<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CONCRETRACK ‚Ä¢ Massadas</title>

  <!-- PWA (manifest unificado na raiz) -->
  <link rel="manifest" href="../manifest.json">
  <meta name="theme-color" content="#2F3640">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- anti-cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg0:#2F3640; --bg1:#262C35; --bg2:#1F242C;
      --line: rgba(255,255,255,.12); --line2: rgba(255,255,255,.18);
      --text:#F3F6FF; --muted:#B9C4D0;
      --ok:#16A34A; --warn:#F59E0B; --err:#EF4444;
      --accent:#D946EF;
      --shadow: 0 18px 45px rgba(0,0,0,.45);
    }
    *{ box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body{
      margin:0; min-height:100vh; color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,255,255,.06), transparent 55%),
        radial-gradient(900px 600px at 80% 30%, rgba(0,0,0,.35), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg2));
    }
    .wrap{ max-width:720px; margin:0 auto; padding:18px; }
    .title{ font-size:28px; font-weight:1000; letter-spacing:.3px; }
    .subtitle{ font-size:14px; color:var(--muted); margin:6px 0 10px; line-height:1.2; }
    .accentLine{ height:4px; border-radius:999px; background: linear-gradient(90deg,#D946EF,#8B5CF6,transparent); opacity:.9; margin:10px 0 14px; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.20));
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      display:grid;
      gap:14px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(6px);
    }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
    .ops{ display:flex; gap:10px; flex-wrap:wrap; }
    .field{ background: rgba(0,0,0,.25); border:1px solid var(--line2); border-radius:14px; padding:12px; }
    .label{ font-size:14px; font-weight:900; color:var(--muted); }
    input, select, textarea{
      margin-top:8px; width:100%;
      font-size:18px; font-weight:900;
      padding:14px; border-radius:14px;
      border:1px solid rgba(217,70,239,.35);
      background: rgba(0,0,0,.35);
      color:var(--text);
      outline:none;
      font-family: inherit;
    }
    input:focus, select:focus, textarea:focus{
      box-shadow:0 0 0 4px rgba(217,70,239,.15);
      border-color: rgba(217,70,239,.55);
    }
    select option{ background:#1F242C; color:var(--text); }
    textarea{ resize:vertical; min-height:80px; }

    .btn{
      padding:18px; border-radius:18px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.30);
      color:var(--text);
      font-weight:1000;
      font-size:18px;
      cursor:pointer;
      flex:1;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.good{ background: linear-gradient(180deg,#D946EF,#A21CAF); color:#fff; border-color: rgba(217,70,239,.9); text-shadow: 0 1px 0 rgba(0,0,0,.20); }
    .btn.light{ background: rgba(255,255,255,.06); }
    .btn.danger{ background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.35); }

    .pillRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{
      display:flex; align-items:center; gap:12px;
      padding:16px 18px;
      border-radius:999px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.30);
      font-size:16px;
      font-weight:900;
      flex: 1;
      min-width: 200px;
    }
    .dot{ width:14px; height:14px; border-radius:999px; background:var(--muted); }
    .dot.ok{ background:var(--ok); }
    .dot.warn{ background:var(--warn); }
    .dot.err{ background:var(--err); }

    .segRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .segBtn{
      flex:1; min-width:90px;
      padding:14px 10px;
      border-radius:14px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.30);
      color:var(--muted);
      font-weight:900; font-size:15px;
      cursor:pointer; text-align:center;
      user-select:none;
      transition: all .15s ease;
    }
    .segBtn.active{
      background: rgba(217,70,239,.25);
      border-color: rgba(217,70,239,.7);
      color:var(--text);
    }

    .history{ margin-top:16px; }
    .histItem{
      display:flex; justify-content:space-between; align-items:center; gap:8px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      margin-bottom:8px;
      font-size:14px;
      flex-wrap:wrap;
    }
    .histItem b{ color:var(--accent); }

    @media(max-width:520px){
      .grid2, .grid3{ grid-template-columns:1fr; }
      .segRow{ flex-direction:column; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <a href="../index.html" style="display:inline-flex;align-items:center;gap:8px;color:var(--muted);text-decoration:none;font-size:14px;font-weight:900;margin-bottom:8px;">‚Üê Hub</a>
  <div class="title">üß± CONCRETRACK ‚Ä¢ Massadas</div>
  <div class="subtitle">Registrar massadas com problemas ‚Üí Planilha Google Sheets</div>
  <div class="accentLine"></div>

  <div class="card">
    <form id="frm" autocomplete="off">

      <div class="grid2">
        <div class="field">
          <div class="label">Data</div>
          <input id="data" type="date" required>
        </div>
        <div class="field">
          <div class="label">Hora</div>
          <input id="hora" type="time" step="60" required>
        </div>
      </div>

      <div class="grid2">
        <div class="field">
          <div class="label">ID / N¬∫ da Massada</div>
          <input id="massada" placeholder="Ex.: M-2026-045" required>
        </div>
        <div class="field">
          <div class="label">Tra√ßo</div>
          <input id="traco" placeholder="Ex.: TR-320" required>
        </div>
      </div>

      <div class="grid3">
        <div class="field">
          <div class="label">Volume (m¬≥)</div>
          <input id="volume" type="number" min="0" step="0.1" placeholder="Ex.: 8.0" required>
        </div>
        <div class="field">
          <div class="label">Cimento (kg)</div>
          <input id="cimento" type="number" min="0" step="1" placeholder="Ex.: 3200">
        </div>
        <div class="field">
          <div class="label">√Ågua (L)</div>
          <input id="agua" type="number" min="0" step="1" placeholder="Ex.: 1600">
        </div>
      </div>

      <div class="field">
        <div class="label">Tipo de Problema</div>
        <div class="segRow">
          <div class="segBtn" data-group="problema" data-value="Slump fora">üìâ Slump fora</div>
          <div class="segBtn" data-group="problema" data-value="Segrega√ß√£o">üíß Segrega√ß√£o</div>
          <div class="segBtn" data-group="problema" data-value="Pega r√°pida">‚è±Ô∏è Pega r√°pida</div>
          <div class="segBtn" data-group="problema" data-value="Excesso √°gua">üåä Excesso √°gua</div>
          <div class="segBtn" data-group="problema" data-value="Outros">üìã Outros</div>
        </div>
        <input type="hidden" id="problema" value="">
      </div>

      <div class="field">
        <div class="label">A√ß√£o Tomada</div>
        <div class="segRow">
          <div class="segBtn" data-group="acao" data-value="Descartada">üóëÔ∏è Descartada</div>
          <div class="segBtn" data-group="acao" data-value="Corrigida">üîß Corrigida</div>
          <div class="segBtn" data-group="acao" data-value="Aprovada c/ restri√ß√£o">‚ö†Ô∏è Aprovada c/ restri√ß√£o</div>
        </div>
        <input type="hidden" id="acao" value="">
      </div>

      <div class="field">
        <div class="label">Observa√ß√µes</div>
        <textarea id="observacoes" placeholder="Descreva o problema e detalhes adicionais..."></textarea>
      </div>

      <div class="ops">
        <button class="btn light" id="btnAgora" type="button">üïí Agora</button>
        <button class="btn danger" id="btnLimpar" type="button">üßπ Limpar</button>
        <button class="btn good" id="btnSalvar" type="submit">üì§ REGISTRAR</button>
      </div>

      <div class="pillRow">
        <div class="pill">
          <span id="dot" class="dot warn"></span>
          <span id="statusTxt">Pronto para registrar</span>
        </div>
      </div>

    </form>
  </div>

  <div class="history" id="history"></div>
</div>

<script>
/* ===============================
   ‚úÖ SW UNIFICADO
   =============================== */
(async function(){
  try{
    if ("serviceWorker" in navigator) {
      await navigator.serviceWorker.register("../sw.js", { scope: "../" });
    }
  }catch(e){}
})();

/* ===============================
   ‚úÖ CONFIG ‚Äî Substitua pela URL do seu Apps Script
   =============================== */
const CONFIG = {
  API_URL: "COLE_AQUI_SUA_URL_DO_APPS_SCRIPT"
};

const $ = (id) => document.getElementById(id);

const frm = $("frm");
const dot = $("dot");
const statusTxt = $("statusTxt");

/* ===============================
   ‚úÖ HELPERS
   =============================== */
function pad2(n){ return String(n).padStart(2,"0"); }

function setStatus(kind, text){
  dot.classList.remove("ok","warn","err");
  dot.classList.add(kind);
  statusTxt.textContent = text;
}

function setNow(){
  const d = new Date();
  $("data").value = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  $("hora").value = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

/* ===============================
   ‚úÖ SEGMENTED BUTTONS
   =============================== */
function setActive(group, value){
  document.querySelectorAll(`.segBtn[data-group="${group}"]`).forEach(b => {
    b.classList.toggle("active", b.dataset.value === value);
  });
  const hidden = $(group);
  if (hidden) hidden.value = value;
}

document.querySelectorAll(".segBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    setActive(btn.dataset.group, btn.dataset.value);
  });
});

/* ===============================
   ‚úÖ EVENTS
   =============================== */
$("btnAgora").addEventListener("click", () => { setNow(); });

$("btnLimpar").addEventListener("click", () => {
  frm.reset();
  $("problema").value = "";
  $("acao").value = "";
  setActive("problema", "");
  setActive("acao", "");
  setStatus("warn", "Pronto para registrar");
});

/* ===============================
   ‚úÖ HIST√ìRICO LOCAL
   =============================== */
function loadHistory(){
  const hist = JSON.parse(localStorage.getItem("massadas_hist") || "[]");
  const el = $("history");
  if (!hist.length){ el.innerHTML = ""; return; }
  el.innerHTML = "<div class='label' style='margin-bottom:8px;'>√öltimos registros</div>" +
    hist.slice(-5).reverse().map(h =>
      `<div class="histItem">
        <span>${h.data} ${h.hora}</span>
        <b>${h.massada}</b>
        <span>${h.problema}</span>
        <span>${h.acao}</span>
      </div>`
    ).join("");
}

function saveHistory(payload){
  const hist = JSON.parse(localStorage.getItem("massadas_hist") || "[]");
  hist.push(payload);
  if (hist.length > 20) hist.splice(0, hist.length - 20);
  localStorage.setItem("massadas_hist", JSON.stringify(hist));
  loadHistory();
}

/* ===============================
   ‚úÖ SALVAR ‚Üí GOOGLE SHEETS
   =============================== */
async function apiPost(payload){
  const res = await fetch(CONFIG.API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  });
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { ok:false, raw:text }; }
}

frm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const problema = $("problema").value;
  const acao = $("acao").value;

  if (!problema){
    setStatus("warn", "Selecione o Tipo de Problema");
    return;
  }
  if (!acao){
    setStatus("warn", "Selecione a A√ß√£o Tomada");
    return;
  }

  const payload = {
    action: "registrar_massada",
    data: $("data").value,
    hora: $("hora").value,
    massada: $("massada").value.trim(),
    traco: $("traco").value.trim(),
    volume: $("volume").value || "",
    cimento: $("cimento").value || "",
    agua: $("agua").value || "",
    problema: problema,
    acao: acao,
    observacoes: $("observacoes").value.trim()
  };

  if (!payload.data || !payload.hora || !payload.massada || !payload.traco || !payload.volume){
    setStatus("warn", "Preencha todos os campos obrigat√≥rios");
    return;
  }

  setStatus("warn", "Salvando...");
  $("btnSalvar").disabled = true;

  try {
    const r = await apiPost(payload);
    if (r && r.ok){
      setStatus("ok", "Massada registrada ‚úÖ");
      saveHistory(payload);

      // Limpar formul√°rio mantendo a data
      const keepData = $("data").value;
      const keepHora = $("hora").value;
      frm.reset();
      $("problema").value = "";
      $("acao").value = "";
      setActive("problema", "");
      setActive("acao", "");
      $("data").value = keepData;
      $("hora").value = keepHora;
    } else {
      setStatus("err", "Erro: " + (r?.message || r?.error || "Falha ao salvar"));
    }
  } catch(err){
    console.error(err);
    setStatus("err", "Erro de conex√£o ‚ùå");
  } finally {
    $("btnSalvar").disabled = false;
  }
});

/* ===============================
   ‚úÖ INIT
   =============================== */
setNow();
setStatus("warn", "Pronto para registrar");
loadHistory();
</script>
</body>
</html>
